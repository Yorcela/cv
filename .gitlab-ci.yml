# Pipeline CI/CD pour déploiement automatique du CV Angular
stages:
  - build
  - deploy

variables:
  NODE_VERSION: "18"
  DIST_FOLDER: "dist/alec-cv-site"

# Cache pour accélérer les builds
cache:
  paths:
    - node_modules/
    - .angular/

# Build de l'application Angular
build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - npm run build
  artifacts:
    paths:
      - ${DIST_FOLDER}/
    expire_in: 1 hour
  only:
    - main
    - develop

# Déploiement sur FTP (uniquement pour la branche main)
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache lftp
  script:
    - |
      lftp -c "
        set ftp:ssl-allow no;
        set ftp:passive-mode on;
        open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST;
        lcd ${DIST_FOLDER};
        cd $FTP_REMOTE_PATH;
        mirror --reverse --delete --verbose --exclude-glob .git* --exclude-glob .DS_Store;
        bye
      "
  dependencies:
    - build
  only:
    - main
  when: manual  # Déploiement manuel pour plus de sécurité

# Déploiement automatique optionnel (décommentez si vous voulez un déploiement automatique)
# deploy_auto:
#   stage: deploy
#   image: alpine:latest
#   before_script:
#     - apk add --no-cache lftp
#   script:
#     - |
#       lftp -c "
#         set ftp:ssl-allow no;
#         set ftp:passive-mode on;
#         open -u $FTP_USERNAME,$FTP_PASSWORD $FTP_HOST;
#         lcd ${DIST_FOLDER};
#         cd $FTP_REMOTE_PATH;
#         mirror --reverse --delete --verbose --exclude-glob .git* --exclude-glob .DS_Store;
#         bye
#       "
#   dependencies:
#     - build
#   only:
#     - main

# Job de test optionnel
# test:
#   stage: test
#   image: node:${NODE_VERSION}
#   before_script:
#     - npm ci --cache .npm --prefer-offline
#   script:
#     - npm run test -- --watch=false --browsers=ChromeHeadless
#   only:
#     - main
#     - develop
#     - merge_requests